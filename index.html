
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payes SuperFast Chat</title>
    <style>
        /* --- 1. SETUP & LAYOUT --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Roboto", "Segoe UI", Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #1e1e1e; height: 100vh; display: flex; justify-content: center; overflow: hidden; }

        .wallpaper-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.pexels.com/photos/15036815/pexels-photo-15036815.jpeg');
            background-size: cover; background-position: center; background-repeat: no-repeat;
            z-index: 0; pointer-events: none;
        }

        .mobile-frame { 
            width: 100%; max-width: 450px; height: 100%; 
            background-color: transparent; display: flex; flex-direction: column; position: relative; 
            overflow: hidden; z-index: 1; 
        }

        /* --- UI ELEMENTS --- */
        .header { background-color: #517DA2; height: 55px; padding: 0 10px; display: flex; align-items: center; gap: 10px; color: white; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: 20; position: relative; }
        .back-btn { width: 24px; height: 24px; fill: white; cursor: pointer; }
        .profile-pic { width: 38px; height: 38px; border-radius: 50%; background: #333; object-fit: cover; }
        .user-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .user-name { font-weight: 600; font-size: 16px; }
        .user-status { font-size: 12px; opacity: 0.8; }
        .header-icon { width: 24px; height: 24px; fill: white; cursor: pointer; margin-left: 10px; padding: 2px; border-radius: 50%; }

        .chat-list { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; scroll-behavior: smooth; padding-bottom: 20px; z-index: 10; }
        .date-label { align-self: center; background: rgba(0,0,0,0.3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin: 10px 0; }

        .message-row { display: flex; width: 100%; margin-bottom: 8px; position: relative; flex-shrink: 0; transition: all 0.3s ease; } 
        .message-row.deleting { opacity: 0; transform: scale(0.9); height: 0; margin: 0; }
        .bubble { max-width: 80%; padding: 6px 10px; border-radius: 8px; font-size: 16px; line-height: 1.3; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; cursor: pointer; }
        .bubble.has-media { padding: 3px; border-radius: 8px; background: transparent; }
        
        .msg-sent { justify-content: flex-end; }
        .msg-sent .bubble { background-color: #EEFFDE; color: #000; border-bottom-right-radius: 0; }
        .msg-received { justify-content: flex-start; }
        .msg-received .bubble { background-color: #FFFFFF; color: #000; border-bottom-left-radius: 0; }
        .msg-time { float: right; font-size: 11px; color: #559C43; margin-top: 6px; margin-left: 8px; display: flex; align-items: center; gap: 2px; }
        .msg-received .msg-time { color: #a0a0a0; }

        /* MEDIA & PROGRESS UI */
        .media-container { position: relative; width: 200px; height: 300px; border-radius: 6px; overflow: hidden; background: #000; display: flex; justify-content: center; align-items: center; }
        .chat-media { width: 100%; height: 100%; object-fit: cover; display: block; transition: filter 0.3s; }
        .chat-media.blur { filter: blur(10px); }

        /* Progress Overlay */
        .progress-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; gap: 10px; transition: opacity 0.3s;
        }
        .progress-circle {
            width: 50px; height: 50px; border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #25D366;
            animation: spin 1s linear infinite;
        }
        .progress-text { font-size: 14px; font-weight: 600; font-family: monospace; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .chat-play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 45px; height: 45px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; border: 2px solid white; z-index: 2; }
        .chat-play-overlay svg { fill: white; width: 24px; height: 24px; margin-left: 2px; }

        /* Footer */
        .footer-container { background: transparent; display: flex; flex-direction: column; z-index: 20; transition: padding-bottom 0.3s; }
        .preview-scroll-area { display: none; padding: 10px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(2px); overflow-x: auto; white-space: nowrap; gap: 10px; border-radius: 15px; margin: 0 10px 10px 10px; }
        .preview-item { display: inline-block; position: relative; width: 60px; height: 60px; margin-right: 10px; border-radius: 8px; overflow: hidden; border: 2px solid #517DA2; background: #fff; }
        .preview-thumb { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        
        .chat-footer { padding: 5px 8px; display: flex; align-items: flex-end; gap: 8px; min-height: 50px; margin-bottom: 14px; background: transparent; }
        .input-container { flex-grow: 1; background: #FFFFFF; border-radius: 22px; display: flex; align-items: flex-end; padding: 8px 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chat-input { flex-grow: 1; border: none; outline: none; font-size: 17px; max-height: 120px; overflow-y: auto; resize: none; padding: 0 8px; margin-bottom: 2px; background: transparent; }
        .icon-btn, .mic-btn svg, .send-btn svg { fill: #89939B; cursor: pointer; }
        .mic-btn, .send-btn { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); background: #FFF; transition: transform 0.1s; }
        .send-btn { background: #539CDE; display: none; } .send-btn svg { fill: #FFF; }
        .mic-btn:active, .send-btn:active { transform: scale(0.95); }

        /* Media Viewer & Overlays */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 100; display: none; flex-direction: column; justify-content: center; padding: 20px; }
        .overlay.active { display: flex; }
        .action-menu-container { width: 250px; background: #ffffff; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.9); transition: transform 0.2s; }
        .overlay.active .action-menu-container { transform: scale(1); }
        .menu-item { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; font-size: 16px; color: #222; cursor: pointer; font-weight: 500; }
        .menu-item:active { background: #f4f4f4; }
        .menu-item.delete { color: #FF3B30; } 
        .menu-icon { width: 24px; height: 24px; margin-right: 18px; fill: currentColor; }

        .media-viewer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: none; justify-content: center; align-items: center; }
        .media-viewer.active { display: flex; }
        .media-viewer img, .media-viewer video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .viewer-header { position: absolute; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.6); display: flex; align-items: center; padding: 0 10px; color: white; z-index: 210; transition: transform 0.3s; }
        .viewer-header.hidden { transform: translateY(-100%); }
        .viewer-back { width: 24px; height: 24px; fill: white; margin-right: 10px; }
        .viewer-actions svg { width: 24px; height: 24px; fill: white; margin-left: 15px; }
        .center-play-btn { position: absolute; width: 60px; height: 60px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 205; }
        .center-play-btn svg { fill: white; width: 30px; height: 30px; margin-left: 3px; }
        .video-controls { position: absolute; bottom: 0; width: 100%; padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); display: flex; gap: 10px; color: white; z-index: 210; align-items: center; transition: transform 0.3s; }
        .video-controls.hidden { transform: translateY(100%); }
        .video-progress { flex-grow: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; -webkit-appearance: none; }
        .video-progress::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #25D366; border-radius: 50%; }
        
        .settings-menu, .viewer-menu { position: absolute; top: 55px; right: 10px; background: white; border-radius: 10px; padding: 5px 0; display: none; flex-direction: column; z-index: 220; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .settings-menu.active, .viewer-menu.active { display: flex; }
    </style>
</head>
<body>

    <div class="mobile-frame">
        <div class="wallpaper-bg" id="wallpaperBg"></div>

        <!-- HEADER -->
        <div class="header">
            <svg class="back-btn" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100" class="profile-pic">
            <div class="user-info">
                <div class="user-name">Cobb</div>
                <div class="user-status">online</div>
            </div>
            <svg class="header-icon" id="threeDotsBtn" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            
            <div class="settings-menu" id="settingsMenu">
                <div class="setting-item" id="btnChangeBg">Change Wallpaper</div>
                <div class="setting-item delete" id="btnClearChat">Clear History</div>
            </div>
            <input type="file" id="bgInput" style="display: none;" accept="image/*">
        </div>

        <!-- CHAT LIST -->
        <div class="chat-list" id="chatList">
            <div class="date-label">Today</div>
        </div>

        <!-- FOOTER -->
        <div class="footer-container">
            <input type="file" id="fileInput" multiple style="display: none;">
            <div class="preview-scroll-area" id="previewArea"></div>
            <div class="chat-footer">
                <div class="input-container">
                    <svg class="icon-btn" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                    <textarea id="msgInput" class="chat-input" placeholder="Message" rows="1"></textarea>
                    <svg id="attachBtn" class="icon-btn" style="margin-left: 5px; transform: rotate(45deg);" viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                </div>
                <div class="action-btn-wrapper">
                    <div class="mic-btn" id="micBtn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>
                    <div class="send-btn" id="sendBtn"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></div>
                </div>
            </div>
        </div>

        <!-- POPUP MENU -->
        <div class="overlay" id="actionOverlay">
            <div class="action-menu-container">
                <div class="menu-item" onclick="menuAction('edit')"><svg class="menu-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</div>
                <div class="menu-item" onclick="menuAction('reply')"><svg class="menu-icon" viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>Reply</div>
                <div class="menu-item" onclick="menuAction('copy')"><svg class="menu-icon" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</div>
                <div class="menu-item delete" onclick="menuAction('delete')"><svg class="menu-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</div>
            </div>
        </div>

        <!-- MEDIA VIEWER -->
        <div class="media-viewer" id="mediaViewer">
            <div class="viewer-header" id="viewerHeader">
                <svg class="viewer-back" viewBox="0 0 24 24" onclick="closeViewer()"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                <div class="viewer-info"><div class="viewer-name">Cobb</div><div class="viewer-time">Today</div></div>
                <div class="viewer-actions"><svg class="viewer-icon" id="viewerMenuBtn" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>
                <div class="viewer-menu" id="viewerMenu">
                    <div class="v-menu-item" onclick="viewerAction('save')">Save</div>
                    <div class="v-menu-item delete" onclick="viewerAction('delete')">Delete</div>
                </div>
            </div>
            <div class="media-content-wrapper" onclick="toggleControls()">
                <img id="viewerImage" src="" style="display:none;">
                <video id="viewerVideo" src="" style="display:none;" ontimeupdate="updateVidProgress()"></video>
                <div class="center-play-btn" id="centerPlayBtn" style="display:none;" onclick="togglePlay(event)"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                <div class="video-controls" id="videoControls" style="display:none;">
                    <span class="video-time" id="vCurTime">0:00</span>
                    <input type="range" class="video-progress" id="vProgress" value="0" oninput="seekVideo()">
                    <span class="video-time" id="vDurTime">0:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SOCKET.IO & SCRIPT -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Sounds
        const sndSent = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'); 
        const sndRecv = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

        // State for File Transfer
        const CHUNK_SIZE = 1024 * 1024; // 1 MB Chunk
        let incomingFiles = {}; // Store incoming chunks

        // DOM
        const input = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const chatList = document.getElementById('chatList');
        const fileInput = document.getElementById('fileInput');
        const previewArea = document.getElementById('previewArea');
        let selectedFiles = [];
        let activeRow = null;

        // --- SOCKET EVENTS ---
        
        // 1. Text Message
        socket.on('receiveMessage', (data) => {
            sndRecv.play();
            addMessage(data.content, data.type, 'received');
        });

        // 2. File Start (Prepare to receive)
        socket.on('file-start', (data) => {
            incomingFiles[data.id] = { buffer: [], total: data.totalChunks, type: data.type };
            // Create bubble with progress bar
            const row = addMessage('', data.type, 'received', data.id);
            updateProgress(row, 0);
        });

        // 3. File Chunk (Add to buffer)
        socket.on('file-chunk', (data) => {
            const file = incomingFiles[data.id];
            if(file) {
                file.buffer.push(data.chunk);
                // Update UI Progress
                const percent = Math.round((file.buffer.length / file.total) * 100);
                const row = document.getElementById('row-' + data.id);
                if(row) updateProgress(row, percent);
            }
        });

        // 4. File End (Compile and Show)
        socket.on('file-end', (data) => {
            const file = incomingFiles[data.id];
            if(file) {
                const blob = new Blob(file.buffer, { type: file.type === 'video' ? 'video/mp4' : 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                
                const row = document.getElementById('row-' + data.id);
                if(row) {
                    completeDownload(row, url, file.type);
                    sndRecv.play();
                }
                delete incomingFiles[data.id];
            }
        });

        // --- FUNCTIONS ---

        // Input Logic
        input.addEventListener('input', () => {
            const hasText = input.value.trim().length > 0;
            micBtn.style.display = hasText ? 'none' : 'flex';
            sendBtn.style.display = hasText ? 'flex' : 'none';
            input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px';
        });

        document.getElementById('attachBtn').onclick = () => fileInput.click();
        fileInput.onchange = () => {
            if(fileInput.files.length) {
                Array.from(fileInput.files).forEach(f => selectedFiles.push(f));
                renderPreviews();
                fileInput.value = '';
            }
        };

        function renderPreviews() {
            previewArea.innerHTML = '';
            if(selectedFiles.length > 0) {
                previewArea.style.display = 'block';
                sendBtn.style.display = 'flex'; micBtn.style.display = 'none';
                selectedFiles.forEach((file, idx) => {
                    const d = document.createElement('div'); d.className = 'preview-item';
                    const img = document.createElement('img'); 
                    img.className = 'preview-thumb';
                    img.src = URL.createObjectURL(file); // Thumbnail
                    const x = document.createElement('div'); x.className='preview-remove'; x.innerHTML='Ã—';
                    x.onclick = () => { selectedFiles.splice(idx, 1); renderPreviews(); };
                    d.appendChild(img); d.appendChild(x);
                    previewArea.appendChild(d);
                });
            } else {
                previewArea.style.display = 'none';
                if(!input.value.trim()) { sendBtn.style.display = 'none'; micBtn.style.display = 'flex'; }
            }
        }

        document.getElementById('actionBtn').onclick = () => {
            if(sendBtn.style.display === 'flex') sendMessage();
        };

        async function sendMessage() {
            const text = input.value.trim();
            if(text) {
                addMessage(text, 'text', 'sent');
                socket.emit('chatMessage', { content: text, type: 'text' });
                input.value = ''; input.style.height = 'auto';
                sndSent.play();
            }

            if(selectedFiles.length > 0) {
                for(const file of selectedFiles) {
                    const type = file.type.startsWith('video') ? 'video' : 'image';
                    const id = Date.now() + Math.random().toString(36).substr(2, 9);
                    
                    // Show Sending UI
                    const row = addMessage(URL.createObjectURL(file), type, 'sent', id);
                    const mediaEl = row.querySelector('.chat-media');
                    mediaEl.classList.add('blur'); // Blur initially
                    
                    // Chunk Upload Logic
                    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                    
                    socket.emit('file-start', { id, totalChunks, type });

                    for (let i = 0; i < totalChunks; i++) {
                        const start = i * CHUNK_SIZE;
                        const end = Math.min(file.size, start + CHUNK_SIZE);
                        const chunk = file.slice(start, end);
                        
                        socket.emit('file-chunk', { id, chunk });
                        
                        // Update Local UI
                        const percent = Math.round(((i + 1) / totalChunks) * 100);
                        updateProgress(row, percent);
                        
                        // Small delay to prevent freezing UI
                        await new Promise(r => setTimeout(r, 5));
                    }

                    socket.emit('file-end', { id });
                    completeDownload(row, URL.createObjectURL(file), type); // Show clear image
                    sndSent.play();
                }
                selectedFiles = []; renderPreviews();
            }
            micBtn.style.display='flex'; sendBtn.style.display='none';
        }

        // Add Message to Chat
        function addMessage(content, type, dir, id = null) {
            const div = document.createElement('div');
            div.className = `message-row msg-${dir}`;
            if(id) div.id = 'row-' + id;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let tick = dir === 'sent' ? '<svg viewBox="0 0 24 24" width="16" fill="#53bdeb"><path d="M17.3 3.3c.4-.4 1-.4 1.4 0s.4 1 0 1.4l-9.3 9.3-3.3-3.3c-.4-.4-.4-1 0-1.4s1-.4 1.4 0l1.9 1.9 7.9-7.9zm-4.3 9.3 1.4 1.4-4.3 4.3-5.3-5.3 1.4-1.4 3.9 3.9 2.9-2.9z"/></svg>' : '';

            let html = '';
            if(type === 'text') {
                html = `<div class="bubble">${content}<div class="msg-time">${time} ${tick}</div></div>`;
            } else {
                // Media Layout
                html = `
                <div class="bubble has-media" style="background:${dir==='sent'?'#EEFFDE':'#FFF'}">
                    <div class="media-container">
                        ${type==='image' 
                            ? `<img src="${content || ''}" class="chat-media blur">` 
                            : `<video src="${content || ''}" class="chat-media blur" muted></video>`
                        }
                        
                        <!-- Progress Overlay -->
                        <div class="progress-overlay">
                            <div class="progress-circle"></div>
                            <div class="progress-text">0%</div>
                        </div>

                        <!-- Video Play Overlay (Hidden initially) -->
                        ${type==='video' ? `<div class="chat-play-overlay" style="display:none"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>` : ''}
                    </div>
                    <div class="msg-time" style="position:absolute; bottom:5px; right:10px; color:white; background:rgba(0,0,0,0.4); padding:2px 6px; border-radius:10px;">${time} ${tick.replace('#53bdeb','white')}</div>
                </div>`;
            }

            div.innerHTML = html;
            chatList.appendChild(div);
            chatList.scrollTop = chatList.scrollHeight;
            
            // Attach Events
            const bubble = div.querySelector('.bubble');
            attachBubbleEvents(bubble, type, content, div);
            
            return div;
        }

        // Update Progress Bar
        function updateProgress(row, percent) {
            const text = row.querySelector('.progress-text');
            if(text) text.innerText = percent + '%';
        }

        // Finish Upload/Download
        function completeDownload(row, url, type) {
            const overlay = row.querySelector('.progress-overlay');
            const media = row.querySelector('.chat-media');
            const playBtn = row.querySelector('.chat-play-overlay');

            if(overlay) overlay.style.opacity = '0';
            setTimeout(() => { if(overlay) overlay.style.display = 'none'; }, 300);
            
            if(media) {
                media.src = url;
                media.classList.remove('blur');
                if(type === 'video' && playBtn) {
                    playBtn.style.display = 'flex';
                    // Thumbnail trick
                    const v = media; v.currentTime = 0.1;
                }
            }
            
            // Update onclick to open viewer
            const bubble = row.querySelector('.bubble');
            attachBubbleEvents(bubble, type, url, row);
        }

        // --- EVENTS ---
        function attachBubbleEvents(el, type, content, row) {
            let pressTimer;
            
            const start = () => {
                pressTimer = setTimeout(() => {
                    activeRow = row;
                    document.getElementById('actionOverlay').classList.add('active');
                    if(navigator.vibrate) navigator.vibrate(50);
                }, 500);
            };
            const end = () => clearTimeout(pressTimer);
            const click = () => {
                if(type === 'text') {
                    // Text click action if needed
                } else if(row.querySelector('.progress-overlay').style.display === 'none') {
                    // Only open if download complete
                    openViewer(content, type);
                }
            };

            el.addEventListener('touchstart', start);
            el.addEventListener('touchend', end);
            el.addEventListener('mousedown', start);
            el.addEventListener('mouseup', end);
            el.addEventListener('click', click);
        }

        // --- VIEWER LOGIC ---
        function openViewer(src, type) {
            const v = document.getElementById('mediaViewer');
            const vid = document.getElementById('viewerVideo');
            const img = document.getElementById('viewerImage');
            const playBtn = document.getElementById('centerPlayBtn');
            const ctrls = document.getElementById('videoControls');

            if(type === 'image') {
                img.src = src; img.style.display = 'block';
                vid.style.display = 'none'; playBtn.style.display = 'none'; ctrls.style.display = 'none';
            } else {
                vid.src = src; vid.style.display = 'block';
                img.style.display = 'none'; playBtn.style.display = 'flex'; ctrls.style.display = 'flex';
            }
            v.classList.add('active');
        }

        function closeViewer() {
            document.getElementById('mediaViewer').classList.remove('active');
            document.getElementById('viewerVideo').pause();
        }

        // Video Controls
        const vVid = document.getElementById('viewerVideo');
        function togglePlay(e) {
            e.stopPropagation();
            if(vVid.paused) { vVid.play(); document.getElementById('centerPlayBtn').style.opacity = 0; }
            else { vVid.pause(); document.getElementById('centerPlayBtn').style.opacity = 1; }
        }
        function updateVidProgress() {
            if(vVid.duration) {
                document.getElementById('vProgress').value = (vVid.currentTime / vVid.duration) * 100;
                document.getElementById('vCurTime').innerText = fmtTime(vVid.currentTime);
                document.getElementById('vDurTime').innerText = fmtTime(vVid.duration);
            }
        }
        function seekVideo() {
            const val = document.getElementById('vProgress').value;
            vVid.currentTime = (val / 100) * vVid.duration;
        }
        function fmtTime(s) {
            const m = Math.floor(s/60); const sc = Math.floor(s%60);
            return `${m}:${sc < 10 ? '0'+sc : sc}`;
        }
        function toggleControls() {
            const h = document.getElementById('viewerHeader');
            const c = document.getElementById('videoControls');
            if(h.classList.contains('hidden')) { h.classList.remove('hidden'); if(vVid.style.display==='block') c.classList.remove('hidden'); }
            else { h.classList.add('hidden'); c.classList.add('hidden'); }
        }

        // Menu Actions
        function menuAction(act) {
            if(!activeRow) return;
            if(act === 'delete') { activeRow.classList.add('deleting'); setTimeout(() => activeRow.remove(), 300); }
            else if(act === 'copy') { navigator.clipboard.writeText(activeRow.innerText); }
            else if(act === 'reply') { input.focus(); input.placeholder = "Replying..."; }
            document.getElementById('actionOverlay').classList.remove('active');
        }
        document.getElementById('actionOverlay').onclick = (e) => {
            if(e.target.id === 'actionOverlay') e.target.classList.remove('active');
        };

        // Viewer Menu
        document.getElementById('viewerMenuBtn').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('viewerMenu').classList.toggle('active');
        };
        function viewerAction(act) {
            alert(act);
            document.getElementById('viewerMenu').classList.remove('active');
        }

    </script>
</body>
</html>
