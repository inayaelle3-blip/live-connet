<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payes Chat Ultimate</title>
    
    <style>
        /* --- RESET & LAYOUT --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f0f2f5; min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .mobile-frame { width: 100%; max-width: 412px; height: 100vh; max-height: 900px; background-color: #f5f5f5; position: relative; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.1); }
        @media (max-width: 450px) { body { background-color: #fff; } .mobile-frame { height: 100vh; max-height: none; box-shadow: none; max-width: 100%; } }

        /* --- HEADER --- */
        .chat-header { background: #fff; border-bottom: 1px solid #eee; padding: 0 15px; height: 65px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; z-index: 10; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #f0f0f0; }
        .chat-info { flex-grow: 1; }
        .chat-title { font-size: 17px; font-weight: 700; color: #1e2329; }
        .chat-status { font-size: 13px; color: #00d600; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 8px; height: 8px; background: #00d600; border-radius: 50%; display: inline-block; }

        /* --- CHAT AREA --- */
        .chat-list { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 20px 20px; background-color: #f7f9fa; }
        .date-badge { align-self: center; background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #666; margin: 10px 0; }
        
        /* --- BUBBLE STYLES --- */
        .message-row { display: flex; align-items: flex-end; width: 100%; animation: fadeIn 0.2s ease; margin-bottom: 4px; }
        .avatar-small { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; flex-shrink: 0; margin-bottom: 2px; }
        
        .bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; line-height: 1.4; width: fit-content; max-width: 80%; word-wrap: break-word; white-space: pre-wrap; box-shadow: 0 1px 1px rgba(0,0,0,0.04); position: relative; display: flex; flex-direction: column; }
        .bubble.is-media { background: transparent !important; padding: 0 !important; box-shadow: none !important; }

        /* Media Content */
        .chat-media-content { width: 100%; max-width: 240px; display: block; border-radius: 13px; cursor: pointer; transition: transform 0.1s; }
        .chat-video-content { width: 100%; max-width: 240px; border-radius: 13px; background: #000; cursor: pointer; }

        /* File Content */
        .file-attachment { display: flex; align-items: center; gap: 10px; padding: 5px; background: rgba(0,0,0,0.05); border-radius: 6px; }
        .file-icon { width: 34px; height: 34px; background: #f44336; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 9px; color: #fff; text-transform: uppercase; }
        .file-name { font-size: 14px; font-weight: 500; text-decoration: none; color: #333; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- TICKS & TIME --- */
        .msg-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 2px; margin-left: 5px; float: right; }
        .msg-time { font-size: 10px; color: #888; }
        .tick-icon { width: 14px; height: 14px; }
        
        .tick-grey svg { fill: #999; }
        .tick-blue svg { fill: #34B7F1; } 

        /* Colors */
        .msg-sent { justify-content: flex-end; }
        .msg-sent .bubble { background-color: #d1fcdb; color: #0b3d18; border-bottom-right-radius: 4px; margin-right: 8px; }
        .msg-received { justify-content: flex-start; }
        .msg-received .bubble { background-color: #ffffff; color: #1e2329; border-bottom-left-radius: 4px; margin-left: 8px; }

        @keyframes fadeIn { from{ opacity:0; transform:translateY(5px); } to{ opacity:1; transform:translateY(0); } }

        /* --- FOOTER & PREVIEW --- */
        .footer-container { background: #fff; border-top: 1px solid #eee; flex-shrink: 0; display: flex; flex-direction: column; }
        .preview-scroll-area { display: none; padding: 10px; background: #f9f9f9; border-bottom: 1px solid #eee; overflow-x: auto; white-space: nowrap; gap: 10px; }
        .preview-item { display: inline-block; position: relative; width: 60px; height: 60px; margin-right: 10px; border-radius: 8px; overflow: hidden; border: 2px solid #ddd; background: #fff; vertical-align: top; }
        .preview-thumb { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; border: none; width: 20px; height: 20px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .chat-footer { padding: 10px 12px; display: flex; align-items: flex-end; gap: 8px; min-height: 60px; }
        .input-wrapper { flex-grow: 1; background: #f0f2f5; border-radius: 24px; display: flex; align-items: center; padding: 5px 10px 5px 15px; min-height: 48px; }
        .chat-input { width: 100%; background: transparent; border: none; font-size: 16px; outline: none; caret-color: #00d600; resize: none; max-height: 120px; overflow-y: auto; line-height: 1.4; padding: 10px 0; font-family: inherit; }
        .icon-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; padding: 5px; flex-shrink: 0; }
        .icon-btn:hover svg { stroke: #00d600; }
        .chat-send-btn { width: 48px; height: 48px; background: #00d600; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px 8px rgba(0,214,0,0.3); transition: transform 0.1s; flex-shrink: 0; }
        .chat-send-btn:active { transform: scale(0.95); }
        .chat-send-btn svg { width: 22px; height: 22px; fill: white; }

        /* --- VIEWER --- */
        #mediaViewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
            opacity: 0; transition: opacity 0.3s ease;
        }
        #mediaViewer.active { opacity: 1; }
        .viewer-content {
            max-width: 100%; max-height: 100%; object-fit: contain;
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #mediaViewer.active .viewer-content { transform: scale(1); }
        .viewer-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2001; }

        #loadingOverlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index: 50; align-items: center; justify-content: center; flex-direction: column; color: #00d600; font-weight: bold; }
    </style>
</head>
<body>

    <!-- Viewer -->
    <div id="mediaViewer">
        <button class="viewer-close-btn" onclick="closeViewer()">×</button>
        <img id="viewerImage" class="viewer-content" style="display:none;">
        <video id="viewerVideo" class="viewer-content" controls style="display:none;"></video>
    </div>

    <!-- Hidden SVGs for Ticks -->
    <div style="display:none;">
        <svg id="icon-tick-double" viewBox="0 0 16 16"><path d="M10.91 3.316l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88l-2.09-2.066a.364.364 0 0 0-.51-.004l-.42.426a.356.356 0 0 0-.003.504l2.766 2.735a.363.363 0 0 0 .513.003l5.897-6.645a.365.365 0 0 0-.056-.514h-.253zm5.023.273l-.422-.424a.365.365 0 0 0-.514-.002L9.58 8.84l-.162.163.513.513.16-.164 5.914-6.67a.364.364 0 0 0 .004-.512l-.076.12z"></path></svg>
    </div>

    <div class="mobile-frame">
        <div id="loadingOverlay">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00d600" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>
            <span style="margin-top:10px;">Saving & Sending...</span>
        </div>
        <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

        <div class="chat-header">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="chat-avatar">
            <div class="chat-info">
                <div class="chat-title">Payes Support</div>
                <div class="chat-status"><span class="status-dot"></span>Online</div>
            </div>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        </div>

        <div class="chat-list" id="chatList">
            <div class="date-badge">Today</div>
            <div style="text-align:center; color:#999; font-size:12px; margin-bottom:10px;">Messages saved to Phone Storage.</div>
        </div>

        <div class="footer-container">
            <input type="file" id="fileInput" multiple style="display: none;">
            <div class="preview-scroll-area" id="previewArea"></div>

            <div class="chat-footer">
                <div class="input-wrapper">
                    <textarea class="chat-input" id="msgInput" placeholder="Message" rows="1"></textarea>
                    <button type="button" class="icon-btn" id="attachBtn" style="margin-left: 5px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                </div>
                <button id="sendBtn" class="chat-send-btn">
                    <svg viewBox="0 0 32 32" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:serif="http://www.serif.com/" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.499,19.173l5.801,-5.849c0.389,-0.392 1.022,-0.394 1.414,-0.006c0.392,0.389 0.395,1.022 0.006,1.414l-5.798,5.847l5.306,8.002c0.207,0.313 0.572,0.483 0.945,0.441c0.373,-0.042 0.691,-0.289 0.824,-0.64l9.024,-23.904c0.138,-0.366 0.05,-0.78 -0.226,-1.058c-0.276,-0.278 -0.689,-0.369 -1.057,-0.233l-24.004,8.892c-0.353,0.13 -0.602,0.448 -0.646,0.821c-0.044,0.373 0.125,0.74 0.438,0.948l7.973,5.325Z"/><g id="Icon"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- DATABASE SETUP (IndexedDB) ---
        let db;
        const request = indexedDB.open("PayesChatDB", 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            // Create a store for messages, using 'id' as key
            db.createObjectStore("messages", { keyPath: "id" });
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadMessagesFromDB(); // Load saved messages on startup
        };

        request.onerror = function(event) {
            console.log("Database error: " + event.target.errorCode);
        };

        function saveMessageToDB(data) {
            if(!db) return;
            const transaction = db.transaction(["messages"], "readwrite");
            transaction.objectStore("messages").add(data);
        }

        function loadMessagesFromDB() {
            if(!db) return;
            const transaction = db.transaction(["messages"], "readonly");
            const objectStore = transaction.objectStore("messages");
            const request = objectStore.getAll();

            request.onsuccess = function(event) {
                const messages = event.target.result;
                messages.forEach(msg => addMessage(msg, false)); // false means don't scroll hard on load
                // Scroll to bottom after loading all
                setTimeout(() => {
                    chatList.scrollTop = chatList.scrollHeight;
                }, 100);
            };
        }

        // --- CHAT LOGIC ---
        // Get name from storage or create new
        let myName = localStorage.getItem("chatUsername");
        if(!myName) {
            myName = "Guest " + Math.floor(Math.random() * 9000 + 1000);
            localStorage.setItem("chatUsername", myName);
        }
        
        const socket = io();
        
        const sendBtn = document.getElementById('sendBtn');
        const input = document.getElementById('msgInput');
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');
        const chatList = document.getElementById('chatList');
        const previewArea = document.getElementById('previewArea');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Viewer Elements
        const mediaViewer = document.getElementById('mediaViewer');
        const viewerImage = document.getElementById('viewerImage');
        const viewerVideo = document.getElementById('viewerVideo');

        let selectedFiles = [];

        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        attachBtn.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                Array.from(this.files).forEach(file => { selectedFiles.push(file); });
                renderPreviews();
                this.value = '';
            }
        });

        function renderPreviews() {
            previewArea.innerHTML = '';
            if (selectedFiles.length === 0) { previewArea.style.display = 'none'; return; }
            previewArea.style.display = 'block';
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file); img.className = 'preview-thumb';
                    item.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.style.cssText = "width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#eee; font-size:10px;";
                    icon.innerText = file.type.split('/')[0].toUpperCase();
                    item.appendChild(icon);
                }
                const btn = document.createElement('div'); btn.className = 'preview-remove'; btn.innerHTML = '×';
                btn.onclick = () => removeFile(index); item.appendChild(btn);
                previewArea.appendChild(item);
            });
        }
        function removeFile(index) { selectedFiles.splice(index, 1); renderPreviews(); }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text && selectedFiles.length === 0) return;
            if (selectedFiles.length > 0) loadingOverlay.style.display = 'flex';

            if (text) {
                const msgId = Date.now() + Math.random().toString(16).slice(2);
                const msgData = { id: msgId, user: myName, type: 'text', content: text, time: getTime() };
                socket.emit('chat message', msgData);
                // Note: Server will emit back, we save then. Or we can save immediately optimistically.
                // Let's rely on server echo to keep it synced.
                input.value = ""; input.style.height = 'auto';
            }

            for (const file of selectedFiles) { await readFileAndSend(file); }

            selectedFiles = []; renderPreviews(); loadingOverlay.style.display = 'none';
        }

        function readFileAndSend(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let type = 'file';
                    if (file.type.startsWith('image/')) type = 'image';
                    if (file.type.startsWith('video/')) type = 'video';
                    const msgId = Date.now() + Math.random().toString(16).slice(2);
                    const msgData = { id: msgId, user: myName, type: type, content: e.target.result, fileName: file.name, time: getTime() };
                    socket.emit('chat message', msgData);
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        function getTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

        sendBtn.addEventListener('click', (e) => { e.preventDefault(); sendMessage(); });

        // --- RECEIVE LOGIC ---
        socket.on('chat message', (data) => {
            // Check if already in UI (to prevent duplicates if server sends history + we load local)
            if (document.getElementById('row-' + data.id)) return;

            addMessage(data, true);
            saveMessageToDB(data); // Save to Phone Storage

            if (data.user !== myName) {
                socket.emit('message read', data.id);
            }
        });

        socket.on('message read', (msgId) => {
            const tickEl = document.getElementById(`tick-${msgId}`);
            if (tickEl) {
                tickEl.classList.remove('tick-grey');
                tickEl.classList.add('tick-blue');
            }
        });

        function addMessage(data, scroll) {
            // Prevent duplicates
            if (document.getElementById('row-' + data.id)) return;

            const isMe = data.user === myName;
            const row = document.createElement('div');
            row.id = 'row-' + data.id; // Unique ID for Row
            row.classList.add('message-row');
            row.classList.add(isMe ? 'msg-sent' : 'msg-received');

            let contentHtml = '';
            let bubbleClass = 'bubble';

            if (data.type === 'image') {
                contentHtml = `<img src="${data.content}" class="chat-media-content" onclick="openMedia('image', '${data.content}')">`;
                bubbleClass += ' is-media';
            } else if (data.type === 'video') {
                contentHtml = `<video src="${data.content}" class="chat-video-content" onclick="openMedia('video', '${data.content}')"></video>`;
                bubbleClass += ' is-media';
            } else if (data.type === 'file') {
                contentHtml = `<div class="file-attachment"><div class="file-icon">DOC</div><a href="${data.content}" download="${data.fileName}" class="file-name">${data.fileName}</a></div>`;
            } else {
                contentHtml = `<div style="margin-right:20px; margin-bottom:5px;">${data.content}</div>`;
            }

            let metaHtml = '';
            if (isMe) {
                const tickSvg = document.getElementById('icon-tick-double').innerHTML;
                metaHtml = `<div class="msg-meta"><span class="msg-time">${data.time}</span><span id="tick-${data.id}" class="tick-icon tick-grey"><svg viewBox="0 0 16 16">${tickSvg}</svg></span></div>`;
            } else {
                metaHtml = `<div class="msg-meta"><span class="msg-time">${data.time}</span></div>`;
            }

            let html = '';
            if (isMe) {
                if(bubbleClass.includes('is-media')) {
                    html = `<div class="${bubbleClass}">${contentHtml}<div style="background:rgba(0,0,0,0.3); border-radius:10px; padding:2px 6px; position:absolute; bottom:5px; right:5px; display:flex;">${metaHtml.replace('tick-grey', 'tick-grey style="fill:white"').replace('color: #888', 'color: #fff')}</div></div><img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="avatar-small">`;
                } else {
                    html = `<div class="${bubbleClass}">${contentHtml}${metaHtml}</div><img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="avatar-small">`;
                }
            } else {
                html = `<img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="avatar-small"><div class="${bubbleClass}">${contentHtml}${metaHtml}</div>`;
            }

            row.innerHTML = html;
            chatList.appendChild(row);
            
            if(scroll) {
                chatList.scrollTop = chatList.scrollHeight;
            }
        }

        // --- SMOOTH VIEWER ANIMATION ---
        function openMedia(type, src) {
            mediaViewer.style.display = 'flex';
            setTimeout(() => { mediaViewer.classList.add('active'); }, 10);
            if (type === 'image') {
                viewerImage.style.display = 'block'; viewerVideo.style.display = 'none'; viewerImage.src = src;
            } else {
                viewerImage.style.display = 'none'; viewerVideo.style.display = 'block'; viewerVideo.src = src; viewerVideo.play();
            }
        }
        function closeViewer() {
            mediaViewer.classList.remove('active');
            setTimeout(() => { mediaViewer.style.display = 'none'; viewerVideo.pause(); viewerVideo.src = ""; viewerImage.src = ""; }, 300);
        }
        mediaViewer.addEventListener('click', (e) => { if(e.target === mediaViewer) closeViewer(); });
        socket.on('connect', () => { document.querySelector('.status-dot').style.background = "#00d600"; });
        socket.on('disconnect', () => { document.querySelector('.status-dot').style.background = "red"; });
    </script>
</body>
</html>
